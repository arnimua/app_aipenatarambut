<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Penata Rambut</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles untuk melengkapi Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #38bdf8, #a78bfa, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        /* Animasi fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Staggered animation delay */
        .recommendation-card {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased">

    <!-- Container Utama Aplikasi -->
    <div id="app" class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="w-full max-w-4xl mx-auto text-center mb-8">
            <div class="flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-fuchsia-400"><path d="M14 12a2 2 0 1 0-4 0"/><path d="M12 2a2.5 2.5 0 0 0-2.5 2.5V8"/><path d="M12 2a2.5 2.5 0 0 1 2.5 2.5V8"/><path d="M17 9.5a2.5 2.5 0 0 1 2.5 2.5v0a2.5 2.5 0 0 1-2.5 2.5h-10A2.5 2.5 0 0 1 4.5 12v0a2.5 2.5 0 0 1 2.5-2.5"/><path d="M12 15v6"/><path d="M9.5 15a2.5 2.5 0 0 1-2.5 2.5v0a2.5 2.5 0 0 1-2.5-2.5"/><path d="M14.5 15a2.5 2.5 0 0 1 2.5 2.5v0a2.5 2.5 0 0 1 2.5-2.5"/></svg>
                <h1 class="text-3xl md:text-4xl font-bold gradient-text">AI Penata Rambut</h1>
            </div>
            <p class="text-slate-400 mt-2">Temukan gaya rambut sempurna dengan kekuatan AI.</p>
        </header>

        <!-- Konten Utama (dinamis) -->
        <main class="flex-grow flex items-center justify-center w-full">
            <div id="main-content" class="w-full max-w-4xl">
                <!-- Step 1: API Key Input -->
                <div id="apiKeyScreen">
                    <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl max-w-md mx-auto text-center shadow-lg border border-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-sky-400 mb-4"><path d="M12 3c.3 0 .5.2.5.5v3c0 .3-.2.5-.5.5s-.5-.2-.5-.5v-3c0-.3.2-.5.5-.5zM6.4 6.4c.2-.2.5-.2.7 0l2.1 2.1c.2.2.2.5 0 .7s-.5.2-.7 0L6.4 7.1c-.2-.2-.2-.5 0-.7zM3 12c0-.3.2-.5.5-.5h3c.3 0 .5.2.5.5s-.2.5-.5.5h-3c-.3 0-.5-.2-.5-.5zM6.4 17.6c-.2.2-.2.5 0 .7l2.1 2.1c.2.2.5.2.7 0s.2-.5 0-.7l-2.1-2.1c-.2-.2-.5-.2-.7 0zM12 21c-.3 0-.5-.2-.5-.5v-3c0-.3.2-.5.5-.5s.5.2.5.5v3c0 .3-.2.5-.5.5zM17.6 17.6c.2-.2.5-.2.7 0l2.1-2.1c.2-.2.2-.5 0-.7s-.5-.2-.7 0l-2.1 2.1c-.2.2-.2-.5 0 .7zM21 12c0 .3-.2.5-.5.5h-3c-.3 0-.5-.2-.5-.5s.2-.5.5-.5h3c.3 0 .5.2.5.5zM17.6 6.4c.2.2.5.2.7 0l-2.1-2.1c-.2-.2-.5-.2-.7 0s-.2.5 0 .7l2.1 2.1c.2.2.2.5 0 .7z"/></svg>
                        <h2 class="text-2xl font-bold mb-2 text-white">Masukkan API Key Gemini</h2>
                        <p class="text-slate-400 mb-6">Untuk memulai, silakan masukkan API Key Google AI Anda.</p>
                        <form id="apiKeyForm" class="space-y-4">
                            <input type="password" id="apiKeyInput" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="•••••••••••••••••••••••••••••••••••">
                            <p id="apiKeyError" class="text-red-400 text-sm text-left hidden h-4"></p>
                            <button id="apiKeySubmit" type="submit" disabled class="w-full flex items-center justify-center gap-2 bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-500 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed">
                                Lanjutkan
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                        </form>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="mt-4 inline-flex items-center gap-2 text-sm text-sky-400 hover:text-sky-300">
                            Dapatkan API Key di Google AI Studio
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        </a>
                    </div>
                </div>

                <!-- Step 2: Welcome Screen -->
                <div id="welcomeScreen" class="hidden">
                    <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl max-w-3xl mx-auto text-center shadow-lg border border-slate-700">
                        <h2 class="text-3xl font-bold mb-3 text-white">Selamat Datang!</h2>
                        <p class="text-slate-400 mb-8 max-w-xl mx-auto">Siap untuk transformasi? Aplikasi ini akan menganalisis wajah Anda dan memberikan rekomendasi gaya rambut yang paling sesuai dalam 3 langkah mudah.</p>
                        <div class="grid md:grid-cols-3 gap-6 mb-8 text-left">
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <div class="flex items-center gap-3">
                                    <div class="bg-sky-500/20 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg></div>
                                    <h3 class="font-semibold text-white">1. Ambil Foto</h3>
                                </div>
                                <p class="text-slate-400 text-sm mt-2">Gunakan kamera Anda untuk mengambil foto wajah yang jelas.</p>
                            </div>
                             <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <div class="flex items-center gap-3">
                                    <div class="bg-indigo-500/20 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                                    <h3 class="font-semibold text-white">2. Beri Konteks</h3>
                                </div>
                                <p class="text-slate-400 text-sm mt-2">Tambahkan info singkat (opsional) untuk hasil yang lebih personal.</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                <div class="flex items-center gap-3">
                                    <div class="bg-fuchsia-500/20 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-fuchsia-400"><path d="M12 3c.3 0 .5.2.5.5v3c0 .3-.2.5-.5.5s-.5-.2-.5-.5v-3c0-.3.2-.5.5-.5zM6.4 6.4c.2-.2.5-.2.7 0l2.1 2.1c.2.2.2.5 0 .7s-.5.2-.7 0L6.4 7.1c-.2-.2-.2-.5 0-.7zM3 12c0-.3.2-.5.5-.5h3c.3 0 .5.2.5.5s-.2.5-.5.5h-3c-.3 0-.5-.2-.5-.5zM6.4 17.6c-.2.2-.2.5 0 .7l2.1 2.1c.2.2.5.2.7 0s.2-.5 0-.7l-2.1-2.1c-.2-.2-.5-.2-.7 0zM12 21c-.3 0-.5-.2-.5-.5v-3c0-.3.2-.5.5-.5s.5.2.5.5v3c0 .3-.2-.5-.5.5zM17.6 17.6c.2-.2.5-.2.7 0l2.1-2.1c.2-.2.2-.5 0-.7s-.5-.2-.7 0l-2.1 2.1c-.2.2-.2-.5 0 .7zM21 12c0 .3-.2.5-.5.5h-3c-.3 0-.5-.2-.5-.5s.2-.5.5-.5h3c.3 0 .5.2.5.5zM17.6 6.4c.2.2.5.2.7 0l-2.1-2.1c-.2-.2-.5-.2-.7 0s-.2.5 0 .7l2.1 2.1c.2.2.2.5 0 .7z"/></svg></div>
                                    <h3 class="font-semibold text-white">3. Dapatkan Hasil</h3>
                                </div>
                                <p class="text-slate-400 text-sm mt-2">Lihat beberapa rekomendasi gaya rambut yang dibuat khusus untuk Anda.</p>
                            </div>
                        </div>
                        <button id="startButton" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-500 transition-all transform hover:scale-105">
                            Mulai Sekarang
                        </button>
                    </div>
                </div>

                <!-- Step 3: Image Uploader -->
                <div id="imageUploaderScreen" class="hidden">
                    <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl max-w-3xl mx-auto shadow-lg border border-slate-700">
                        <div id="error-message" class="hidden bg-red-500/20 text-red-400 border border-red-500/30 p-3 rounded-lg mb-6 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            <span id="error-text"></span>
                        </div>
                        
                        <div id="upload-options" class="grid md:grid-cols-1 gap-6">
                            <button id="openCameraButton" class="bg-slate-800 border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:border-sky-500 hover:bg-slate-700/50 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-sky-400 mb-4"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                                <h3 class="text-xl font-semibold text-white">Gunakan Kamera</h3>
                                <p class="text-slate-400">Ambil foto baru menggunakan kamera perangkat Anda.</p>
                            </button>
                        </div>

                        <div id="camera-view" class="hidden">
                            <video id="video-feed" class="w-full rounded-lg aspect-video bg-slate-900" autoplay playsinline></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <div class="mt-4 flex justify-center gap-4">
                                <button id="captureButton" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-500 transition-all">Ambil Gambar</button>
                                <button id="cancelCameraButton" class="bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-500 transition-all">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: User Info Form -->
                <div id="userInfoFormScreen" class="hidden">
                     <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl max-w-4xl mx-auto shadow-lg border border-slate-700">
                        <div class="grid md:grid-cols-2 gap-8 items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2 text-white">Satu Langkah Lagi!</h2>
                                <p class="text-slate-400 mb-6">Pratinjau foto Anda. Berikan sedikit konteks (opsional) untuk rekomendasi yang lebih akurat.</p>
                                <img id="image-preview" src="" alt="Pratinjau Gambar" class="w-full rounded-lg aspect-square object-cover border-2 border-slate-700">
                            </div>
                            <form id="userInfoForm" class="space-y-4">
                                <div>
                                    <label for="age" class="block text-sm font-medium text-slate-300 mb-1">Usia Anda</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        </div>
                                        <input type="number" id="age" class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Contoh: 25">
                                    </div>
                                </div>
                                <div>
                                    <label for="occupation" class="block text-sm font-medium text-slate-300 mb-1">Pekerjaan / Gaya Hidup</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                                        </div>
                                        <input type="text" id="occupation" class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Contoh: Profesional Kreatif, Mahasiswa">
                                    </div>
                                </div>
                                <button type="submit" class="w-full flex items-center justify-center gap-2 bg-fuchsia-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-fuchsia-500 transition-all transform hover:scale-105">
                                    Dapatkan Analisis
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Analysis Results -->
                <div id="analysisResultScreen" class="hidden">
                    <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl mx-auto shadow-lg border border-slate-700 mb-6">
                        <h2 class="text-3xl font-bold mb-4 text-white text-center">Hasil Analisis Anda</h2>
                        <div id="face-shape-analysis" class="text-center text-slate-300">
                           <!-- Konten analisis bentuk wajah akan diisi oleh JS -->
                        </div>
                    </div>

                    <div class="relative">
                        <div id="recommendation-grid" class="grid md:grid-cols-2 gap-6">
                            <!-- Kartu rekomendasi akan diisi oleh JS -->
                        </div>
                        <div id="loading-recommendations-overlay" class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-sm flex flex-col items-center justify-center rounded-lg z-10">
                            <div class="w-12 h-12 border-4 border-t-sky-400 border-slate-600 rounded-full animate-spin"></div>
                            <p class="mt-4 text-white font-semibold">Mencari rekomendasi baru...</p>
                        </div>
                    </div>

                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                        <button id="startOverButton" class="bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-500 transition-all">Mulai Lagi</button>
                        <button id="getMoreButton" class="hidden bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-500 transition-all">Dapatkan Rekomendasi Lain</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="w-full max-w-4xl mx-auto text-center mt-8 text-slate-500 text-sm">
            Didukung oleh Gemini AI
        </footer>

    </div>

    <!-- Modal untuk Contoh Gambar -->
    <div id="imageExampleModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-2xl p-8 max-w-sm w-full shadow-lg border border-slate-700 text-center">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Lihat Contoh Gambar</h3>
            <p class="text-slate-400 mb-6">Anda akan diarahkan ke Google Images untuk melihat contoh gaya rambut "<span id="hairstyle-name" class="font-semibold text-sky-400"></span>". Lanjutkan?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-all">Batal</button>
                <a id="modal-confirm" href="#" target="_blank" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-500 transition-all">Lanjutkan</a>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay Global -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 text-white">
        <div class="w-16 h-16 border-4 border-t-fuchsia-500 border-slate-600 rounded-full animate-spin"></div>
        <p id="loading-text" class="mt-4 text-lg font-semibold">Menganalisis...</p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            let currentStep = 'apiKey';
            let apiKey = ''; // Start with empty API key
            let capturedImageBase64 = null;
            let cameraStream = null;
            let allRecommendations = []; // To store recommendations and avoid duplicates

            // --- DOM Element Selection ---
            const mainContent = document.getElementById('main-content');
            const screens = {
                apiKey: document.getElementById('apiKeyScreen'),
                welcome: document.getElementById('welcomeScreen'),
                imageUploader: document.getElementById('imageUploaderScreen'),
                userInfoForm: document.getElementById('userInfoFormScreen'),
                analysisResult: document.getElementById('analysisResultScreen'),
            };
            
            // API Key Screen
            const apiKeyForm = document.getElementById('apiKeyForm');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeySubmit = document.getElementById('apiKeySubmit');
            const apiKeyError = document.getElementById('apiKeyError');

            // Welcome Screen
            const startButton = document.getElementById('startButton');

            // Image Uploader Screen
            const openCameraButton = document.getElementById('openCameraButton');
            const cameraView = document.getElementById('camera-view');
            const uploadOptions = document.getElementById('upload-options');
            const videoFeed = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas');
            const captureButton = document.getElementById('captureButton');
            const cancelCameraButton = document.getElementById('cancelCameraButton');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // User Info Form Screen
            const userInfoForm = document.getElementById('userInfoForm');
            const imagePreview = document.getElementById('image-preview');
            const ageInput = document.getElementById('age');
            const occupationInput = document.getElementById('occupation');

            // Analysis Result Screen
            const faceShapeAnalysisDiv = document.getElementById('face-shape-analysis');
            const recommendationGrid = document.getElementById('recommendation-grid');
            const startOverButton = document.getElementById('startOverButton');
            const getMoreButton = document.getElementById('getMoreButton');
            const loadingRecommendationsOverlay = document.getElementById('loading-recommendations-overlay');

            // Modals & Overlays
            const imageExampleModal = document.getElementById('imageExampleModal');
            const modalTitle = document.getElementById('modal-title');
            const hairstyleNameSpan = document.getElementById('hairstyle-name');
            const modalCancel = document.getElementById('modal-cancel');
            const modalConfirm = document.getElementById('modal-confirm');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loading-text');

            // --- Core Functions ---

            function renderScreen() {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[currentStep]) {
                    screens[currentStep].classList.remove('hidden');
                    screens[currentStep].classList.add('fade-in');
                }
            }
            
            function toggleLoading(show, text = 'Menganalisis...') {
                loadingText.textContent = text;
                loadingOverlay.classList.toggle('hidden', !show);
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }
            
            function showApiKeyError(message) {
                apiKeyError.textContent = message;
                apiKeyError.classList.remove('hidden');
            }

            function cleanBase64(base64) {
                return base64.replace(/^data:image\/(png|jpeg|jpg);base64,/, "");
            }

            // --- Camera Logic ---
            
            async function startCamera() {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    videoFeed.srcObject = cameraStream;
                    uploadOptions.classList.add('hidden');
                    cameraView.classList.remove('hidden');
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    showError("Tidak dapat mengakses kamera. Pastikan Anda telah memberikan izin.");
                }
            }

            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                uploadOptions.classList.remove('hidden');
                cameraView.classList.add('hidden');
            }

            function takePicture() {
                const context = canvas.getContext('2d');
                canvas.width = videoFeed.videoWidth;
                canvas.height = videoFeed.videoHeight;
                context.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
                
                capturedImageBase64 = canvas.toDataURL('image/jpeg');
                imagePreview.src = capturedImageBase64;
                stopCamera();
                currentStep = 'userInfoForm';
                renderScreen();
            }

            // --- Gemini API Interaction ---

            async function validateApiKey(keyToTest) {
                if (!keyToTest) return false;
                const validationUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${keyToTest}`;
                try {
                    const response = await fetch(validationUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Test" }] }] })
                    });
                    return response.ok;
                } catch (error) {
                    console.error("Validation failed:", error);
                    return false;
                }
            }
            
            async function getHairRecommendations(isGettingMore = false) {
                if (!capturedImageBase64 || !apiKey) {
                    alert("Terjadi kesalahan: Gambar atau API key tidak ditemukan.");
                    return;
                }

                if (isGettingMore) {
                    loadingRecommendationsOverlay.classList.remove('hidden');
                } else {
                    toggleLoading(true, 'AI sedang menganalisis foto Anda...');
                }

                const age = ageInput.value || 'tidak disebutkan';
                const occupation = occupationInput.value || 'tidak disebutkan';

                let previousRecommendationsText = '';
                if (isGettingMore && allRecommendations.length > 0) {
                    const previousNames = allRecommendations.map(r => r.name).join(', ');
                    previousRecommendationsText = `You have already recommended the following styles: ${previousNames}. Please provide completely new and different recommendations.`;
                }

                const prompt = `
                    You are an expert virtual hairstylist and facial analyst. Your task is to analyze the provided user image and suggest hairstyles.

                    Follow these steps precisely:
                    1.  Examine the image to determine if it contains a clear, front-facing human face.
                    2.  If a face is visible, set 'isFace' to true and proceed. If not, set 'isFace' to false and the other fields to "N/A" or empty arrays.
                    3.  Analyze the geometry of the face to determine its shape (e.g., Oval, Round, Square).
                    4.  Take into account the user's details: age is ${age}, occupation is '${occupation}'.
                    5.  Provide hairstyle recommendations categorized into "Solid Cut", "Graduation Cut", "Layered Cut", and "Design Cut".
                    6.  For each recommendation, provide its name, a personalized reason, an 'imageSearchQuery', a 'difficulty' level ('Mudah', 'Sedang', or 'Sulit'), and practical 'careTips'.
                    ${previousRecommendationsText ? `7.  ${previousRecommendationsText}` : ''}
                    ${previousRecommendationsText ? '8' : '7'}. Return the complete analysis strictly in the provided JSON format below. Do not add any text before or after the JSON object.

                    JSON Output Structure:
                    {
                      "isFace": true,
                      "faceShapeAnalysis": {
                        "shape": "Oval",
                        "description": "Indonesian description of the face shape."
                      },
                      "recommendations": {
                        "Solid Cut": [
                          {
                            "name": "Classic Bob",
                            "reason": "Indonesian reason why this style is suitable.",
                            "imageSearchQuery": "classic bob hairstyle",
                            "difficulty": "Mudah",
                            "careTips": ["Indonesian care tip 1", "Indonesian care tip 2"]
                          }
                        ],
                        "Graduation Cut": [],
                        "Layered Cut": [],
                        "Design Cut": []
                      }
                    }

                    IMPORTANT LANGUAGE INSTRUCTION:
                    - The values for 'description', 'reason', and 'careTips' MUST be in Indonesian.
                    - The values for 'shape', 'name', and 'imageSearchQuery' MUST be in English.
                    - The value for 'difficulty' MUST be one of: 'Mudah', 'Sedang', 'Sulit'.
                `;

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: cleanBase64(capturedImageBase64)
                                }
                            }
                        ]
                    }],
                    "generationConfig": {
                        "responseMimeType": "application/json",
                    }
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message}`);
                    }

                    const data = await response.json();
                    const resultData = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    displayResults(resultData, !isGettingMore);

                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    alert(`Terjadi kesalahan saat menghubungi AI: ${error.message}. Pastikan API Key Anda benar dan coba lagi.`);
                    if (!isGettingMore) {
                        currentStep = 'welcome';
                        renderScreen();
                    }
                } finally {
                    if (isGettingMore) {
                        loadingRecommendationsOverlay.classList.add('hidden');
                    } else {
                        toggleLoading(false);
                    }
                }
            }
            
            function displayResults(data, isNewRequest = true) {
                if (data.isFace === false) {
                    alert("Wajah tidak terdeteksi pada gambar. Silakan coba lagi dengan foto yang lebih jelas.");
                    currentStep = 'imageUploader';
                    renderScreen();
                    return;
                }

                if (isNewRequest) {
                    // Defensive check to prevent crash
                    if (data.faceShapeAnalysis && data.faceShapeAnalysis.shape && data.faceShapeAnalysis.description) {
                        faceShapeAnalysisDiv.innerHTML = `<h3 class="text-xl font-bold text-white mb-2">${data.faceShapeAnalysis.shape}</h3><p class="max-w-2xl mx-auto">${data.faceShapeAnalysis.description}</p>`;
                    } else {
                        faceShapeAnalysisDiv.innerHTML = `<p class="max-w-2xl mx-auto">Analisis bentuk wajah tidak dapat ditampilkan saat ini.</p>`;
                        console.error("Received data is missing 'faceShapeAnalysis' structure:", data);
                    }
                    recommendationGrid.innerHTML = '';
                    allRecommendations = []; // Reset state
                }

                const recommendations = data.recommendations;
                if (!recommendations) {
                    console.error("No 'recommendations' object in the response:", data);
                    return; // Exit if there are no recommendations
                }

                for (const category in recommendations) {
                    if (recommendations[category] && recommendations[category].length > 0) {
                        let categoryId = `category-${category.replace(/\s+/g, '-')}`;
                        let categoryHeader = recommendationGrid.querySelector(`#${categoryId}`);
                        if (!categoryHeader) {
                            categoryHeader = document.createElement('div');
                            categoryHeader.id = categoryId;
                            categoryHeader.className = 'md:col-span-2 text-2xl font-bold text-sky-300 mt-6 mb-2 pt-4 border-t border-slate-700';
                            categoryHeader.textContent = category;
                            recommendationGrid.appendChild(categoryHeader);
                        }

                        recommendations[category].forEach((rec, index) => {
                            allRecommendations.push(rec);

                            const card = document.createElement('div');
                            card.className = 'recommendation-card bg-slate-800 p-6 rounded-lg border-l-4 transition-all duration-300 hover:scale-[1.03] hover:shadow-xl';
                            card.style.animation = `fadeIn 0.5s ease-out ${index * 0.15}s forwards`;

                            const difficultyColors = { 'Mudah': 'border-green-400', 'Sedang': 'border-yellow-400', 'Sulit': 'border-red-400' };
                            const difficultyBadgeColors = { 'Mudah': 'bg-green-500/20 text-green-400', 'Sedang': 'bg-yellow-500/20 text-yellow-400', 'Sulit': 'bg-red-500/20 text-red-400' };

                            card.classList.add(difficultyColors[rec.difficulty] || 'border-slate-600');

                            card.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="text-xl font-bold text-white">${rec.name}</h3>
                                    </div>
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${difficultyBadgeColors[rec.difficulty] || 'bg-slate-700'}">${rec.difficulty}</span>
                                </div>
                                <p class="text-slate-300 mb-4 italic">"${rec.reason}"</p>
                                <div>
                                    <h5 class="font-semibold mb-2 text-white">Tips Perawatan:</h5>
                                    <ul class="list-disc list-inside text-slate-400 space-y-1 text-sm">
                                        ${rec.careTips.map(tip => `<li>${tip}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="mt-6 text-right">
                                    <button class="view-example-btn text-sm font-semibold text-sky-400 hover:text-sky-300" data-hairstyle="${rec.imageSearchQuery}">
                                        Lihat Contoh Gambar &rarr;
                                    </button>
                                </div>
                            `;
                            recommendationGrid.appendChild(card);
                        });
                    }
                }

                getMoreButton.classList.remove('hidden');
                currentStep = 'analysisResult';
                renderScreen();
            }

            // --- Event Listeners ---

            apiKeyInput.addEventListener('input', () => {
                apiKeySubmit.disabled = apiKeyInput.value.trim() === '';
                apiKeyError.classList.add('hidden');
            });

            apiKeyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const keyCandidate = apiKeyInput.value.trim();
                if (!keyCandidate) return;

                toggleLoading(true, 'Memverifikasi kunci...');
                const isValid = await validateApiKey(keyCandidate);
                toggleLoading(false);

                if (isValid) {
                    apiKey = keyCandidate;
                    localStorage.setItem('geminiApiKey', apiKey);
                    currentStep = 'welcome';
                    renderScreen();
                } else {
                    showApiKeyError('API Key tidak valid. Silakan periksa kembali.');
                }
            });

            startButton.addEventListener('click', () => {
                currentStep = 'imageUploader';
                renderScreen();
            });

            openCameraButton.addEventListener('click', startCamera);
            cancelCameraButton.addEventListener('click', stopCamera);
            captureButton.addEventListener('click', takePicture);

            userInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                getHairRecommendations(false);
            });

            startOverButton.addEventListener('click', () => {
                capturedImageBase64 = null;
                ageInput.value = '';
                occupationInput.value = '';
                allRecommendations = [];
                getMoreButton.classList.add('hidden');
                currentStep = 'welcome';
                renderScreen();
            });
            
            getMoreButton.addEventListener('click', () => {
                getHairRecommendations(true);
            });
            
            recommendationGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-example-btn')) {
                    const hairstyle = e.target.dataset.hairstyle;
                    hairstyleNameSpan.textContent = hairstyle;
                    modalConfirm.href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(hairstyle)}`;
                    imageExampleModal.classList.remove('hidden');
                }
            });

            modalCancel.addEventListener('click', () => imageExampleModal.classList.add('hidden'));
            modalConfirm.addEventListener('click', () => imageExampleModal.classList.add('hidden'));


            // --- Initialization ---
            async function initialize() {
                const storedKey = localStorage.getItem('geminiApiKey');
                if (storedKey) {
                    toggleLoading(true, 'Memverifikasi kunci tersimpan...');
                    const isValid = await validateApiKey(storedKey);
                    toggleLoading(false);

                    if (isValid) {
                        apiKey = storedKey;
                        currentStep = 'welcome';
                    } else {
                        localStorage.removeItem('geminiApiKey');
                        currentStep = 'apiKey';
                    }
                } else {
                    currentStep = 'apiKey';
                }
                renderScreen();
            }

            initialize();
        });
    </script>
</body>
</html>
